map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}
server {
   
    listen 4443 ssl;
    listen [::]:4443 ssl;

    add_header Allow "GET, POST, HEAD, PUT, DELETE, PATCH" always;
    if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|PATCH)$) {
       	return 405;
    }

    server_name kubevirt-manager.darkfellanetwork.com;
    ssl_certificate /usr/local/openresty/nginx/ssl/tls.crt;
    ssl_certificate_key /usr/local/openresty/nginx/ssl/tls.key;

    root /usr/local/openresty/nginx/html;
    index index.html index.htm;

    location / {
      try_files $uri $uri/ /index.html;
      include /etc/nginx/auth.d/*.conf;
      access_by_lua_block {
        local session = require "resty.session".open()
        local res, err = require("resty.openidc").authenticate(opts, nil, nil, session_opts)
        if err then
          ngx.status = 500
          ngx.say(err)
          ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
        end
          if res.id_token.hd ~= "darkfellanetwork.com" then
            ngx.exit(ngx.HTTP_FORBIDDEN)
          end
          if res.user.email ~= "georgi.panov@darkfellanetwork.com" then
            ngx.exit(ngx.HTTP_FORBIDDEN)
          end
          ngx.req.set_header("X-USER", res.id_token.sub)
        local opts = {
            redirect_uri = "test",
            discovery = "test",
            token_endpoint_auth_method = "client_secret_post",
            client_id = "test",
            client_secret = "test",
            ssl_verify = "yes",
            keepalive = "no",
            response_mode=form_post,
            scope = "openid email profile",
            refresh_session_interval = 900,
            iat_slack = 600,
            redirect_uri_scheme = "https",
            logout_path = "/logout",
            redirect_after_logout_uri = "/",
            redirect_after_logout_with_id_token_hint = true,
            post_logout_redirect_uri = "test",
            accept_none_alg = false,
            accept_unsupported_alg = false,
            renew_access_token_on_expiry = true,
            access_token_expires_in = 3600,
            access_token_expires_leeway = 0,
            force_reauthorize = false,
            session_contents = {id_token=true},
            timeout = 1000,
            timeout = { connect = 500, send = 1000, read = 1000 },
            use_nonce = true,
            revoke_tokens_on_logout = true,
            use_pkce = true
        }
        local session_opts = {
          secret = "test",
          cookie_prefix = "__Host-",
          cookie_http_only = true,
          cookie_secure = true,
          cookie_same_site = "Lax",
          remember = true
        }
        if err then
            ngx.status = 500
            ngx.say(err)
            ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
          end

          -- at this point res is a Lua table with 3 keys:
          --   id_token    : a Lua table with the claims from the id_token (required)
          --   access_token: the access token (optional)
          --   user        : a Lua table with the claims returned from the user info endpoint (optional)

          --if res.id_token.hd ~= "zmartzone.eu" then
          --  ngx.exit(ngx.HTTP_FORBIDDEN)
          --end

          --if res.user.email ~= "hans.zandbelt@zmartzone.eu" then
          --  ngx.exit(ngx.HTTP_FORBIDDEN)
          --end

          -- set headers with user info: this will overwrite any existing headers
          -- but also scrub(!) them in case no value is provided in the token
          ngx.req.set_header("X-USER", res.id_token.sub)
      }
    }

    location /k8s {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "";
        proxy_pass_request_body on;
        proxy_pass_request_headers on;
       	client_max_body_size 5g;
       	proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_pass http://127.0.0.1:8001/k8s;
    }

    include /etc/nginx/location.d/*.conf;

}
